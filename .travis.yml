language: android
android:
  components:
    - build-tools-22.0.1
    - android-22
before_deploy:
  # For historical reasons, Android versionCode started at 1069, and versionName
  # starts with `1.4.5.`
  - export TRAVIS_PUBLISH_DIR="build/publish/1.4.5.$(expr 1069 + $TRAVIS_BUILD_NUMBER)"
  - mkdir -p "$TRAVIS_PUBLISH_DIR"
  - cp build/outputs/apk/*-release.apk "$TRAVIS_PUBLISH_DIR"
          
deploy:
  skip_cleanup: true
  provider: s3
  access_key_id: ${s3_access_id}
  secret_access_key:
    secure: ${s3_access_secret}
  bucket: medic-mobile
  local_dir: build/publish
  upload-dir: builds/medic-collect
  acl: public_read
  on:
    repo: ${TRAVIS_REPO_SLUG}
after_success:
  - git config --global user.email "dev@medicmobile.org"
  - git config --global user.name "Travis CI"
  - git tag travis-$TRAVIS_BUILD_NUMBER
  - git push --tags "https://${github_auth}@github.com/${TRAVIS_REPO_SLUG}" >/dev/null 2>/dev/null
branches:
  except:
      - /^travis-.*/
